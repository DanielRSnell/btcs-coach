import{u as D,r as d,j as s,H as T,a as R}from"./app-t1RLHgKL.js";import{A as k,M as h}from"./app-layout-BpDu9Za0.js";import{C as v,a as L,b as $,d as V,c as I}from"./card-BLBWjmSl.js";import{a as G}from"./app-logo-icon-BqVge3nm.js";import{C as U}from"./clock-ORzcNLF6.js";/* empty css            */import"./index-2Zn7EQ12.js";import"./index-ByTxPp0Z.js";/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const P=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]],M=G("Calendar",P);function Z({user:a,sessions:c,currentSessionId:S,currentSession:E}){console.log("üîç Sessions component loaded with data:"),console.log("üë§ User received:",a?.name,a?.id),console.log("üìä Sessions received:",c),console.log("üìä Sessions type:",typeof c),console.log("üìä Sessions keys:",c?Object.keys(c):"sessions is null/undefined"),console.log("üìä Sessions count:",c?Object.keys(c).length:0),console.log("üéØ Current Session ID received:",S),console.log("üéØ Current Session data received:",E);const{props:W}=D(),[C,j]=d.useState(null),[w,O]=d.useState(!1),[y,f]=d.useState(null),[F,b]=d.useState(!1);d.useEffect(()=>{if(!document.querySelector('script[src*="widget.bundle.mjs"]')){const o=document.createElement("script");o.src="https://cdn.voiceflow.com/widget/bundle.mjs",o.async=!0,o.type="module",o.crossOrigin="anonymous",document.head.appendChild(o)}},[]);const _=()=>{console.log("üîÑ INITIALIZING VOICEFLOW: Starting initialization..."),setTimeout(()=>{console.log("üéØ DOM READY: Starting Voiceflow initialization...");const o=document.getElementById("main-voiceflow-chat");console.log("üìç Chat element found:",o),window.voiceflow&&window.voiceflow.chat?(console.log("‚úÖ VOICEFLOW AVAILABLE: Using existing Voiceflow instance"),x()):(console.log("üöÄ LOADING VOICEFLOW: Loading Voiceflow script..."),function(l,n){const e=l.createElement(n),t=l.getElementsByTagName(n)[0];e.onload=function(){console.log("üì¶ SCRIPT LOADED: Voiceflow script loaded, window.voiceflow:",window.voiceflow),x()},e.src="https://cdn.voiceflow.com/widget/bundle.mjs",e.type="module",e.crossOrigin="anonymous",t.parentNode?.insertBefore(e,t)}(document,"script"))},100)},x=()=>{if(console.log("‚ö° LOADING CHAT: Configuring Voiceflow chat..."),window.voiceflow&&window.voiceflow.chat){const o=document.getElementById("main-voiceflow-chat");console.log("üéØ Target element for Voiceflow:",o);const l={id:a?.id||0,name:a?.name||"Anonymous",email:a?.email||"",role:a?.role||"member",pi_behavioral_pattern_id:a?.pi_behavioral_pattern_id||null,pi_behavioral_pattern:a?.pi_behavioral_pattern||null,pi_raw_scores:a?.pi_raw_scores||null,pi_assessed_at:a?.pi_assessed_at||null,pi_notes:a?.pi_notes||null,pi_profile:a?.pi_profile||null,has_pi_assessment:a?.has_pi_assessment||!1,has_pi_profile:a?.has_pi_profile||!1};console.log("üöÄ Voiceflow User Payload:",JSON.stringify(l,null,2)),window.voiceflow.chat.load({verify:{projectID:"686331bc96acfa1dd62f6fd5"},url:"https://general-runtime.voiceflow.com",versionID:"production",voice:{url:"https://runtime-api.voiceflow.com"},render:{mode:"embedded",target:o},assistant:{stylesheet:"/voiceflow.css?v="+new Date().toISOString().replace(/[:.]/g,"-")},autostart:!0,launch:{event:{type:"launch",payload:l}}}),console.log("‚úÖ CHAT LOADED: Voiceflow chat loaded successfully"),b(!0)}else{console.error("‚ùå VOICEFLOW MISSING: Voiceflow widget failed to load - missing window.voiceflow");const o=document.getElementById("main-voiceflow-chat");o&&(o.innerHTML=`
                    <div class="flex items-center justify-center h-96 bg-gray-50 rounded-lg">
                        <div class="text-center">
                            <div class="text-gray-500 mb-2">Chat widget failed to load</div>
                            <button onclick="location.reload()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                Retry
                            </button>
                        </div>
                    </div>
                `)}};d.useEffect(()=>{console.log("üîÑ COMPONENT MOUNT: Initializing Voiceflow..."),console.log("üë§ User:",a?.name,a?.id),console.log("üìç Current Session ID:",S),_()},[a]);const m=async(o,l)=>{try{console.log(`üì° Making API call to ${o} with data:`,l);const n=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""},body:JSON.stringify(l)});console.log(`üì° Response status: ${n.status} ${n.statusText}`),console.log("üì° Response headers:",Object.fromEntries(n.headers.entries()));const e=await n.text();console.log("üì° Raw response:",e.substring(0,200)+(e.length>200?"...":""));let t;try{t=JSON.parse(e),console.log("üì° Parsed JSON result:",t)}catch(r){return console.error("‚ùå Failed to parse response as JSON:",r),console.log("‚ùå Response was:",e),{error:"Invalid JSON response",raw_response:e}}return t.error==="Unauthenticated"&&console.warn(`üîí Authentication required for ${o}. User may need to log in again.`),t}catch(n){return console.error(`‚ùå API call to ${o} failed:`,n),{error:"Network error",details:n}}},u=()=>{try{const o=Object.keys(localStorage).filter(l=>l.startsWith("voiceflow-session-"));if(o.length===0){f(null);return}for(const l of o){const n=localStorage.getItem(l);if(n)try{const t=JSON.parse(n).userID;if(t&&c[t]){f(t),console.log(`üéØ Current active session identified: ${t} from localStorage key: ${l}`);return}}catch(e){console.warn(`‚ö†Ô∏è Could not parse localStorage session ${l}:`,e);continue}}f(null)}catch(o){console.error("‚ùå Error identifying current active session:",o),f(null)}},p=async(o,l)=>{const n=o.replace("voiceflow-session-","");try{console.log(`üîç Monitoring localStorage key: ${o}`),console.log("üì¶ Raw localStorage value:",l.substring(0,200)+"...");let e;try{e=JSON.parse(l)}catch(i){console.error(`‚ùå Failed to parse localStorage JSON for ${o}:`,i);return}const t=e.userID;if(console.log("üéØ Session Analysis:",{localStorage_key:o,project_id:n,session_userID:t,status:e.status,turns_count:e.turns?.length||0}),!t){console.warn("‚ö†Ô∏è No userID found in localStorage value. Available keys:",Object.keys(e)),console.warn("‚ö†Ô∏è Cannot process session without userID - skipping");return}console.log(`üîç üîç CHECKING: Does session with userID "${t}" exist in database?`);const r=await m("/api/sessions/check",{project_id:n,voiceflow_user_id:t});if(r&&r.error){r.error==="Unauthenticated"?console.warn(`üîí ‚ùå CANNOT CHECK: User not authenticated - skipping session "${t}"`):r.error==="Invalid JSON response"?console.error("üö® ‚ùå API ERROR: Returning HTML instead of JSON - check routes/middleware"):console.error(`‚ùå API ERROR: Failed to check session "${t}":`,r.error);return}if(r&&r.exists){console.log(`‚úÖ ‚úÖ SESSION EXISTS: Found userID "${t}" in database`),console.log("üîÑ üîÑ UPDATING: Syncing current localStorage value to existing session...");const i=await m("/api/sessions/update",{project_id:n,session_data:{last_turn:e,source:"localStorage_sync"}});i?.success?(console.log(`‚úÖ ‚úÖ UPDATE SUCCESS: Session "${t}" updated with latest localStorage data`),console.log(`üìä Updated session now has ${e.turns?.length||0} messages`)):i?.error&&console.error(`‚ùå ‚ùå UPDATE FAILED: Could not update session "${t}":`,i.error)}else{console.log(`üÜï üÜï NEW SESSION DETECTED: userID "${t}" NOT found in database`),console.log("üìù üìù REGISTERING: Creating new session record...");const i={project_id:n,session_data:{last_turn:e,source:"localStorage_sync",detected_at:new Date().toISOString()}};console.log("üìã Registration details:",{project_id:n,userID:t,status:e.status,message_count:e.turns?.length||0});const g=await m("/api/sessions/register",i);g?.success?(console.log(`‚úÖ ‚úÖ REGISTRATION SUCCESS: New session "${t}" created in database`),console.log("üéâ üéâ NEW SESSION ADDED: Refreshing sidebar to show the new session..."),R.reload({only:["sessions"]})):g?.error&&console.error(`‚ùå ‚ùå REGISTRATION FAILED: Could not create session "${t}":`,g.error)}console.log(`üèÅ üèÅ SYNC COMPLETE: Finished processing session "${t}"`),console.log("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ")}catch(e){console.error("‚ùå Error processing localStorage session:",e)}};d.useEffect(()=>{(async()=>{console.log("üîç üöÄ üöÄ STARTING INITIAL LOCALSTORAGE SCAN..."),console.log("üîç Scanning for keys matching pattern: voiceflow-session-*");const l=Object.keys(localStorage).filter(n=>n.startsWith("voiceflow-session-"));console.log(`üì¶ üì¶ FOUND ${l.length} VOICEFLOW SESSION KEYS:`),l.forEach((n,e)=>{console.log(`  ${e+1}. ${n}`)}),l.length===0?console.log("üì≠ No Voiceflow sessions found in localStorage - monitoring for new ones..."):console.log("üîÑ üîÑ PROCESSING EACH SESSION: Checking database and syncing...");for(let n=0;n<l.length;n++){const e=l[n],t=localStorage.getItem(e);console.log(`
üîÑ [${n+1}/${l.length}] PROCESSING: ${e}`),t?await p(e,t):console.warn(`‚ö†Ô∏è ‚ö†Ô∏è WARNING: Key ${e} has no value - skipping`)}console.log(`
‚úÖ ‚úÖ INITIAL SCAN COMPLETE: Processed ${l.length} sessions`),console.log("üéß üéß MONITORING ACTIVE: Watching for localStorage changes..."),console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê")})()},[]),d.useEffect(()=>{c&&Object.keys(c).length>0&&u()},[c]),d.useEffect(()=>{if(w)return;console.log("üéß Setting up CONTINUOUS localStorage monitoring...");const o=async e=>{e.key?.startsWith("voiceflow-session-")&&(console.log("üîÑ üîÑ LOCALSTORAGE CHANGE DETECTED!"),console.log(`üìç Key: ${e.key}`),console.log(`üì¶ New value length: ${e.newValue?.length||0} characters`),console.log("üöÄ üöÄ TRIGGERING SYNC: Processing localStorage change..."),e.newValue?(console.log(`üìã PROCESSING: localStorage change for ${e.key}`),await p(e.key,e.newValue),u()):(console.log(`üóëÔ∏è VALUE REMOVED: localStorage key ${e.key} was deleted (not processing)`),u()))};window.addEventListener("storage",o);const l=localStorage.setItem;localStorage.setItem=function(e,t){const r=new CustomEvent("localStorageChange",{detail:{key:e,newValue:t,oldValue:localStorage.getItem(e)}});l.apply(this,[e,t]),window.dispatchEvent(r)};const n=e=>{const{key:t,newValue:r}=e.detail;t?.startsWith("voiceflow-session-")&&(r&&p(t,r),u())};return window.addEventListener("localStorageChange",n),O(!0),console.log("‚úÖ localStorage listeners set up successfully"),()=>{window.removeEventListener("storage",o),window.removeEventListener("localStorageChange",n),localStorage.setItem=l}},[w]);const N=o=>{try{return new Date(o).toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"})}catch{return"Unknown"}},A=(o,l)=>{console.log(`üîÑ SWITCHING TO SESSION: ${o}`),console.log("üìä Session data:",l);try{console.log("üßπ CLEARING: Removing all voiceflow-session-* from localStorage"),Object.keys(localStorage).filter(g=>g.startsWith("voiceflow-session-")).forEach(g=>{console.log(`üóëÔ∏è Removing: ${g}`),localStorage.removeItem(g)});const t=`voiceflow-session-${l.project_id||"686331bc96acfa1dd62f6fd5"}`,r=l.value||{};console.log(`üìù CREATING: New localStorage entry ${t}`),console.log("üì¶ Session value data:",r),localStorage.setItem(t,JSON.stringify(r)),j(o);const i=`/sessions/${o}`;console.log(`üß≠ NAVIGATING: To ${i} (full page reload)`),window.location.href=i}catch(n){console.error("‚ùå Error switching sessions:",n)}};return s.jsxs(k,{children:[s.jsx(T,{title:"Sessions"}),s.jsxs("div",{className:"flex h-[calc(100vh-8rem)] gap-6 pt-6",children:[s.jsx("div",{className:"w-80 flex-shrink-0",children:s.jsxs(v,{className:"h-full flex flex-col gap-1 py-0 pt-6",children:[s.jsxs(L,{className:"flex-shrink-0",children:[s.jsxs($,{className:"flex items-center gap-2",children:[s.jsx(h,{className:"h-5 w-5"}),"Your Sessions"]}),s.jsxs(V,{children:[Object.keys(c).length," active session",Object.keys(c).length!==1?"s":""]})]}),s.jsx(I,{className:"p-0 flex-1 flex flex-col min-h-0",children:s.jsx("div",{className:"flex-1 overflow-y-auto",children:Object.keys(c).length===0?s.jsx("div",{className:"h-full flex flex-col items-center justify-center p-6 text-center",children:s.jsxs("div",{className:"flex flex-col items-center space-y-4",children:[s.jsx("div",{className:"p-6 bg-gray-50 rounded-full",children:s.jsx(h,{className:"h-10 w-10 text-gray-300"})}),s.jsxs("div",{className:"space-y-2",children:[s.jsx("h3",{className:"text-lg font-semibold text-gray-700",children:"No active sessions yet"}),s.jsx("p",{className:"text-sm text-gray-500 max-w-sm",children:"Start a conversation in the chat area to begin your coaching journey and create your first session."})]}),s.jsx("div",{className:"flex items-center space-x-2 text-xs text-gray-400 mt-6",children:s.jsxs("div",{className:"flex items-center space-x-1",children:[s.jsx("div",{className:"w-2 h-2 bg-green-400 rounded-full animate-pulse"}),s.jsx("span",{children:"Ready to chat"})]})})]})}):s.jsx("div",{className:"p-4 space-y-3",children:Object.entries(c).map(([o,l])=>s.jsxs("div",{className:`p-3 rounded-lg border cursor-pointer transition-colors ${y===o?"bg-green-50 border-green-300 shadow-sm ring-2 ring-green-200":C===o?"bg-blue-50 border-blue-200":"bg-white hover:bg-gray-50"}`,onClick:()=>A(o,l),children:[s.jsx("div",{className:"flex items-start justify-between mb-2",children:s.jsxs("div",{className:"font-medium text-sm truncate flex-1",children:["Session ",o.substring(o.length-8),y===o&&s.jsx("span",{className:"ml-2 text-xs bg-green-500 text-white px-2 py-0.5 rounded-full",children:"Current"})]})}),s.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[s.jsx(M,{className:"h-3 w-3"}),s.jsx("span",{children:N(l.created_at)})]}),s.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500 mt-1",children:[s.jsx(U,{className:"h-3 w-3"}),s.jsxs("span",{children:["Updated ",N(l.updated_at)]})]}),s.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-400 mt-1",children:[s.jsx(h,{className:"h-3 w-3"}),s.jsxs("span",{children:[l.value?.turns?.length||0," messages"]})]})]},o))})})})]})}),s.jsx("div",{className:"flex-1",children:s.jsx(v,{className:"h-full py-0",children:s.jsx(I,{className:"p-0 h-full",children:s.jsx("div",{id:"main-voiceflow-chat",className:"h-full w-full rounded-lg overflow-hidden",children:s.jsx("div",{className:"flex items-center justify-center h-full bg-gray-50",children:s.jsxs("div",{className:"text-center",children:[s.jsx(h,{className:"h-8 w-8 mx-auto mb-4 text-gray-300"}),s.jsx("p",{className:"text-gray-500",children:"Loading chat interface..."})]})})})})})})]})]})}export{Z as default};
